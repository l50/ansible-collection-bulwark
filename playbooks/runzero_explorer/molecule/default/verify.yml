---
- name: Verify
  hosts: all
  gather_facts: true
  vars_files:
    - ../../../../roles/runzero_explorer/defaults/main.yml
    - ../../../../roles/runzero_explorer/vars/main.yml
  tasks:
    - name: Set runzero_explorer_path for Non-Windows
      ansible.builtin.set_fact:
        runzero_explorer_path: "{{ runzero_explorer_nix_path }}"
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
    - name: Set expected package list for Debian
      ansible.builtin.set_fact:
        runzero_explorer_expected_packages: "{{ runzero_explorer_common_install_packages + runzero_explorer_debian_packages }}"
      when: ansible_os_family == 'Debian'
    - name: Set expected package list for RedHat
      ansible.builtin.set_fact:
        runzero_explorer_expected_packages: "{{ runzero_explorer_common_install_packages + runzero_explorer_el_packages }}"
      when: ansible_os_family == 'RedHat'
    - name: Check runzero-explorer packages are installed
      ansible.builtin.package:
        name: "{{ runzero_explorer_expected_packages }}"
        state: present
      check_mode: true
      register: runzero_explorer_package_check
      failed_when: runzero_explorer_package_check.changed
      when:
        - ansible_os_family in ['Debian', 'RedHat']
        - runzero_explorer_expected_packages | length > 0
    - name: Check runzero-explorer directory exists
      ansible.builtin.stat:
        path: "{{ runzero_explorer_path | dirname }}"
      register: runzero_explorer_dir_stat
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
      changed_when: false
    - name: Assert runzero-explorer directory permissions
      ansible.builtin.assert:
        that:
          - runzero_explorer_dir_stat.stat.exists
          - runzero_explorer_dir_stat.stat.isdir
          - runzero_explorer_dir_stat.stat.mode == '0755'
          - runzero_explorer_dir_stat.stat.pw_name == 'root'
        fail_msg: "runzero-explorer directory missing or has incorrect permissions"
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
    - name: Check runzero-explorer binary exists (Non-Windows)
      ansible.builtin.stat:
        path: "{{ runzero_explorer_path }}"
      register: runzero_explorer_stat
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
      changed_when: false
    - name: Assert runzero-explorer binary exists with correct permissions (Non-Windows)
      ansible.builtin.assert:
        that:
          - runzero_explorer_stat.stat.exists
          - runzero_explorer_stat.stat.executable
          - runzero_explorer_stat.stat.mode == '0755'
          - runzero_explorer_stat.stat.pw_name == 'root'
        fail_msg: "runzero-explorer binary missing or has incorrect permissions"
        success_msg: "runzero-explorer binary exists with correct permissions"
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
    - name: Check /etc/environment permissions
      ansible.builtin.stat:
        path: /etc/environment
      register: runzero_explorer_env_stat
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
      changed_when: false
    - name: Assert /etc/environment exists with correct permissions
      ansible.builtin.assert:
        that:
          - runzero_explorer_env_stat.stat.exists
          - runzero_explorer_env_stat.stat.mode == '0644'
        fail_msg: "/etc/environment missing or has incorrect permissions"
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
    - name: Read /etc/environment
      ansible.builtin.slurp:
        src: /etc/environment
      register: runzero_explorer_env_file
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
      changed_when: false
    - name: Assert runzero-explorer environment variables are set
      ansible.builtin.assert:
        that:
          - "'RUNZERO_AGENT_LOG_DEBUG=' in (runzero_explorer_env_file.content | b64decode)"
          - "'RUNZERO_AGENT_HOST_ID=' in (runzero_explorer_env_file.content | b64decode)"
        fail_msg: "runzero-explorer environment variables missing from /etc/environment"
      when: ansible_os_family in ['Debian', 'RedHat', 'Darwin']
